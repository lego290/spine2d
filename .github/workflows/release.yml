name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  validate:
    name: Validate tag/version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF_NAME}"
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Ensure Cargo.toml versions match tag
        run: |
          python3 - <<'PY'
          import os, re, sys, tomllib

          version = os.environ["GITHUB_REF_NAME"].removeprefix("v")
          if not re.fullmatch(r"\d+\.\d+\.\d+", version):
              raise SystemExit(f"Invalid tag version: {version}")

          def read_version(path: str) -> str:
              with open(path, "rb") as f:
                  data = tomllib.load(f)
              return data["package"]["version"]

          crates = {
              "spine2d": read_version("spine2d/Cargo.toml"),
              "spine2d-wgpu": read_version("spine2d-wgpu/Cargo.toml"),
          }
          bad = {k: v for k, v in crates.items() if v != version}
          if bad:
              raise SystemExit(f"Tag v{version} does not match crate versions: {bad}")
          print(f"OK: v{version} matches {crates}")
          PY

  test:
    name: Test before publish
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy (spine2d)
        run: cargo clippy -p spine2d --all-targets --features json,binary,glam -- -D warnings

      - name: Clippy (spine2d-wgpu)
        run: cargo clippy -p spine2d-wgpu --all-targets --features json -- -D warnings

      - name: Test (spine2d)
        run: cargo test -p spine2d --features json,binary,glam

      - name: Cargo package (spine2d)
        run: cargo package -p spine2d

      - name: Cargo package (spine2d-wgpu)
        run: cargo package -p spine2d-wgpu

  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Publish spine2d
        run: cargo publish -p spine2d --token "${{ secrets.CARGO_REGISTRY_TOKEN }}"

      - name: Publish spine2d-wgpu
        run: |
          for i in 1 2 3 4 5 6 7 8 9 10; do
            if cargo publish -p spine2d-wgpu --token "${{ secrets.CARGO_REGISTRY_TOKEN }}"; then
              exit 0
            fi
            echo "spine2d-wgpu publish failed (attempt $i), waiting for crates.io index..."
            sleep 30
          done
          exit 1

  github-release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    needs: publish
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract release notes
        id: notes
        uses: ffurrer2/extract-release-notes@v2

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: ${{ steps.notes.outputs.release_notes }}
